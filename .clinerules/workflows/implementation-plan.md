# План Реализации Проекта "AI Wallpaper"

Этот документ описывает пошаговый план разработки и реализации проекта, основанный на асинхронной архитектуре с разделением на Frontend и Backend.

---

### **Часть 1: Backend (FastAPI, Celery, Redis, S3)**

**Этап 1: Настройка инфраструктуры и безопасности**

*   **Задача 1.1: Инициализация проекта и зависимостей**
    *   **Действие:** Создать структуру проекта FastAPI. Настроить `requirements.txt`, включив `fastapi`, `uvicorn`, `celery`, `redis`, `boto3` (для S3), `pydantic` для валидации.
    *   **Безопасность:** Использовать виртуальное окружение. Зафиксировать версии зависимостей для предотвращения атак на цепочку поставок.

*   **Задача 1.2: Конфигурация инфраструктуры**
    *   **Действие:** Настроить подключение к Redis и S3-совместимому хранилищу.
    *   **Безопасность:** Все ключи доступа, пароли и эндпоинты должны храниться в переменных окружения (`.env`), а не в коде. Для S3 использовать IAM-роли с минимально необходимыми правами.

*   **Задача 1.3: Базовая настройка FastAPI**
    *   **Действие:** Создать основное приложение FastAPI с эндпоинтом для проверки состояния (`/health`). Настроить CORS, чтобы разрешать запросы только с домена фронтенда.
    *   **Безопасность:** Внедрить базовое ограничение по частоте запросов (rate limiting) для защиты от DoS-атак.

**Этап 2: Реализация API эндпоинтов**

*   **Задача 2.1: Эндпоинт создания сессии (`POST /v1/sessions/create`)**
    *   **Действие:** Принимает загруженное изображение интерьера. Генерирует уникальный `session_id` (UUID). Сохраняет изображение во временное хранилище (S3). Создает запись о сессии в Redis со статусом `new` и счетчиком попыток.
    *   **Безопасность:** Строго валидировать тип (`image/jpeg`, `image/png`) и размер загружаемого файла. Очищать метаданные изображения. implementation-plan.md

*   **Задача 2.2: Эндпоинт запуска генерации (`POST /v1/sessions/{session_id}/generate`)**
    *   **Действие:** Принимает `mask` (в Base64) и `wallpaper_url`. Валидирует `session_id` и наличие попыток. Создает задачу для Celery и передает ее в очередь.
    *   **Безопасность:** Валидировать `wallpaper_url` (должен быть валидным HTTP/HTTPS URL), чтобы предотвратить SSRF-атаки. Проверять, что URL ведет на изображение.

*   **Задача 2.3: Эндпоинт проверки статуса (`GET /v1/sessions/{session_id}/status`)**
    *   **Действие:** Получает из Redis и возвращает текущий статус сессии (`queued`, `processing`, `completed`, `failed`) и URL готового изображения, если оно есть.

**Этап 3: Реализация фонового обработчика (Worker)**

*   **Задача 3.1: Создание задачи Celery**
    *   **Действие:** Определить задачу, которая принимает `session_id` и `wallpaper_url`. Внутри задачи обновить статус в Redis на `processing`.
    *   **Безопасность:** Worker должен работать с минимальными правами доступа.

*   **Задача 3.2: Обработка изображений в Worker'е**
    *   **Действие:** Безопасно скачать изображение обоев по `wallpaper_url`. Получить исходное изображение интерьера из S3.
    *   **Безопасность:** Установить таймаут и ограничение на размер скачиваемого файла обоев, чтобы избежать исчерпания ресурсов.

*   **Задача 3.3: Вызов API для генерации изображения (Stable Diffusion)**
    *   **Действие:** Сформировать и отправить запрос к API-провайдеру (например, Replicate, RunPod). Использовать модель инпейнтинга на базе **Stable Diffusion (рекомендуется модель с ControlNet Tile для наилучшего наложения текстуры)**, передав ей:
        1.  Исходное фото интерьера.
        2.  Маску стены.
        3.  Изображение обоев в качестве паттерна.
    *   **Безопасность:** Реализовать надежную обработку ошибок и механизм повторных попыток (retry logic) с экспоненциальной задержкой.

*   **Задача 3.4: Сохранение и обновление результата**
    *   **Действие:** После получения результата от внешнего API, загрузить его в постоянное хранилище S3. Обновить статус сессии в Redis на `completed` и записать публичную ссылку на результат.

---

### **Часть 2: Frontend (Next.js)**

**Этап 4: Настройка проекта и интеграция SAM**

*   **Задача 4.1: Инициализация проекта и управление состоянием**
    *   **Действие:** Настроить проект Next.js. Установить библиотеку для управления состоянием (например, Zustand) для хранения `session_id` и статуса генерации.

*   **Задача 4.2: Интеграция SAM в браузере**
    *   **Действие:** Интегрировать ONNX Runtime и легковесную модель SAM. Создать кастомный хук (`useSAM`) для инкапсуляции логики загрузки модели и создания маски.
    *   **Безопасность:** Убедиться, что модель SAM загружается из доверенного источника.

**Этап 5: Реализация пользовательского интерфейса**

*   **Задача 5.1: Компонент загрузки и создания сессии**
    *   **Действие:** Создать UI для загрузки фото интерьера. После выбора файла отправить его на бэкенд для создания сессии и сохранить полученный `session_id`.

*   **Задача 5.2: Интерактивный редактор маски**
    *   **Действие:** Отобразить загруженное фото. Позволить пользователю кликами (ЛКМ/ПКМ) взаимодействовать с изображением для создания точной маски с помощью `useSAM`.

*   **Задача 5.3: Запуск генерации**
    *   **Действие:** Добавить поле для ввода `wallpaper_url` и кнопку "Сгенерировать". При нажатии отправить маску и URL на бэкенд.

*   **Задача 5.4: Асинхронное отображение результата**
    *   **Действие:** Реализовать механизм опроса (polling) эндпоинта статуса. Отображать пользователю индикаторы загрузки, а по завершении — готовое изображение.
